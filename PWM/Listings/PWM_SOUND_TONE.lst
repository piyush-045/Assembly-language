A51 MACRO ASSEMBLER  PWM_SOUND_TONE                                                       05/16/2025 11:28:14 PAGE     1


MACRO ASSEMBLER A51 V8.2.7.0
OBJECT MODULE PLACED IN .\Objects\PWM_SOUND_TONE.obj
ASSEMBLER INVOKED BY: C:\Keil_v5\C51\BIN\A51.EXE PWM_SOUND_TONE.asm SET(SMALL) DEBUG PRINT(.\Listings\PWM_SOUND_TONE.lst
                      ) OBJECT(.\Objects\PWM_SOUND_TONE.obj) EP

LOC  OBJ            LINE     SOURCE

0000                   1     ORG 00H
0000 020003            2             LJMP MAIN
                       3     
                       4     ;------------------------------------------
                       5     ; Register definitions
  00B3                 6     P1M1      EQU 0B3H
  00B4                 7     P1M2      EQU 0B4H
                       8     
  00D8                 9     PWMCON0   EQU 0D8H
  00DF                10     PWMCON1   EQU 0DFH
  00D1                11     PWMPH     EQU 0D1H
  00D9                12     PWMPL     EQU 0D9H
  00D4                13     PWM2H     EQU 0D4H
  00DC                14     PWM2L     EQU 0DCH
  00DE                15     PIOCON0   EQU 0DEH
  008E                16     CKCON     EQU 08EH
                      17     
                      18     ;------------------------------------------
0003                  19     MAIN:
0003 75B3FE           20             MOV P1M1, #11111110B    ; P1.0 push-pull
0006 75B401           21             MOV P1M2, #00000001B
                      22     
0009 1111             23             ACALL PWM_CONFIG
000B 111F             24             ACALL PWM_START
000D 1122             25             ACALL PLAY_TONE
                      26     
000F 80FE             27     HERE:   SJMP HERE
                      28     
                      29     ;------------------------------------------
0011                  30     PWM_CONFIG:
0011 D2DC             31             SETB PWMCON0.4          ; Clear PWM counter
0013 758E00           32             MOV CKCON, #00H         ; SYSCLK = Fsys
0016 75DF03           33             MOV PWMCON1, #03H       ; Prescaler = 8 (value = 3 ? (3+1)*2)
                      34     
0019 75DE04           35             MOV PIOCON0, #04H       ; Enable PWM0 CH2 at P1.0
001C D2DE             36             SETB PWMCON0.6          ; Trigger LOAD to update values
001E 22               37             RET
                      38     
                      39     ;------------------------------------------
001F                  40     PWM_START:
001F D2DF             41             SETB PWMCON0.7          ; Start PWM
0021 22               42             RET
                      43     
                      44     ;------------------------------------------
                      45     ; Play 10 notes by changing frequency
0022                  46     PLAY_TONE:
0022 900053           47             MOV DPTR, #NOTE_TABLE
0025 7B0A             48             MOV R3, #10             ; 10 notes
                      49     
0027                  50     NEXT_NOTE:
0027 E4               51             CLR A
0028 93               52             MOVC A, @A+DPTR         ; Load PWMPH
0029 F5D1             53             MOV PWMPH, A
002B FC               54             MOV R4, A               ; Save high byte to R4
002C A3               55             INC DPTR
                      56     
002D E4               57             CLR A
A51 MACRO ASSEMBLER  PWM_SOUND_TONE                                                       05/16/2025 11:28:14 PAGE     2

002E 93               58             MOVC A, @A+DPTR         ; Load PWMPL
002F F5D9             59             MOV PWMPL, A
0031 FD               60             MOV R5, A               ; Save low byte to R5
0032 A3               61             INC DPTR
                      62     
                      63             ; Set 50% Duty Cycle = (PWMPH:PWMPL) / 2 ? R4:R5
0033 113C             64             ACALL SET_DUTY_HALF
                      65     
                      66             ; Delay 100ms tone duration
0035 1146             67             ACALL TONE_DELAY
                      68     
0037 DBEE             69             DJNZ R3, NEXT_NOTE
                      70     
0039 C2DF             71             CLR PWMCON0.7           ; Stop PWM
003B 22               72             RET
                      73     
                      74     ;------------------------------------------
                      75     ; Set PWM2H:2L = 50% of PWMPH:PL
003C                  76     SET_DUTY_HALF:
003C ED               77             MOV A, R5
003D C3               78             CLR C
003E 13               79             RRC A
003F F5DC             80             MOV PWM2L, A
                      81     
0041 EC               82             MOV A, R4
0042 13               83             RRC A
0043 F5D4             84             MOV PWM2H, A
0045 22               85             RET
                      86     
                      87     ;------------------------------------------
                      88     ; Delay ~100ms
0046                  89     TONE_DELAY:
0046 7A0A             90             MOV R2, #10
0048 79C8             91     DL1:    MOV R1, #200
004A 78FF             92     DL2:    MOV R0, #255
004C D8FE             93     DL3:    DJNZ R0, DL3
004E D9FA             94             DJNZ R1, DL2
0050 DAF6             95             DJNZ R2, DL1
0052 22               96             RET
                      97     
                      98     ;------------------------------------------
                      99     ; PWMPH:PWMPL values for 10 musical notes (16-bit)
                     100     ; Format: High byte, Low byte
0053                 101     NOTE_TABLE:
0053 1DD1            102             DB 0x1D, 0xD1     ; C4 = 7633
0055 1A93            103             DB 0x1A, 0x93     ; D4 = 6803
0057 17B5            104             DB 0x17, 0xB5     ; E4 = 6061
0059 1663            105             DB 0x16, 0x63     ; F4 = 5731
005B 13EE            106             DB 0x13, 0xEE     ; G4 = 5102
005D 11C1            107             DB 0x11, 0xC1     ; A4 = 4545
005F 0FD2            108             DB 0x0F, 0xD2     ; B4 = 4050
0061 0EEE            109             DB 0x0E, 0xEE     ; C5 = 3822
0063 0D49            110             DB 0x0D, 0x49     ; D5 = 3401
0065 0BD6            111             DB 0x0B, 0xD6     ; E5 = 3030
                     112     
                     113     END
A51 MACRO ASSEMBLER  PWM_SOUND_TONE                                                       05/16/2025 11:28:14 PAGE     3

SYMBOL TABLE LISTING
------ ----- -------


N A M E             T Y P E  V A L U E   ATTRIBUTES

CKCON. . . . . . .  N NUMB   008EH   A   
DL1. . . . . . . .  C ADDR   0048H   A   
DL2. . . . . . . .  C ADDR   004AH   A   
DL3. . . . . . . .  C ADDR   004CH   A   
HERE . . . . . . .  C ADDR   000FH   A   
MAIN . . . . . . .  C ADDR   0003H   A   
NEXT_NOTE. . . . .  C ADDR   0027H   A   
NOTE_TABLE . . . .  C ADDR   0053H   A   
P1M1 . . . . . . .  N NUMB   00B3H   A   
P1M2 . . . . . . .  N NUMB   00B4H   A   
PIOCON0. . . . . .  N NUMB   00DEH   A   
PLAY_TONE. . . . .  C ADDR   0022H   A   
PWM2H. . . . . . .  N NUMB   00D4H   A   
PWM2L. . . . . . .  N NUMB   00DCH   A   
PWMCON0. . . . . .  N NUMB   00D8H   A   
PWMCON1. . . . . .  N NUMB   00DFH   A   
PWMPH. . . . . . .  N NUMB   00D1H   A   
PWMPL. . . . . . .  N NUMB   00D9H   A   
PWM_CONFIG . . . .  C ADDR   0011H   A   
PWM_START. . . . .  C ADDR   001FH   A   
SET_DUTY_HALF. . .  C ADDR   003CH   A   
TONE_DELAY . . . .  C ADDR   0046H   A   


REGISTER BANK(S) USED: 0 


ASSEMBLY COMPLETE.  0 WARNING(S), 0 ERROR(S)
